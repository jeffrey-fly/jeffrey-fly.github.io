<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"jeffrey-fly-github-io.pages.dev","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="QuantumRealm">
<meta property="og:url" content="https://jeffrey-fly-github-io.pages.dev/index.html">
<meta property="og:site_name" content="QuantumRealm">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Jeffrey">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://jeffrey-fly-github-io.pages.dev/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>QuantumRealm</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="QuantumRealm" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">QuantumRealm</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archive"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archive</a></li><li class="menu-item menu-item-docs"><a href="/docs/" rel="section"><i class="fa fa-book fa-fw"></i>docs</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>rss</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jeffrey"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Jeffrey</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:jeffreyfly@icloud.com" title="E-Mail → mailto:jeffreyfly@icloud.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jeffrey-fly-github-io.pages.dev/2026/02/09/tools/How-to-use-openclaw/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jeffrey">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuantumRealm">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | QuantumRealm">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/02/09/tools/How-to-use-openclaw/" class="post-title-link" itemprop="url">How to use openclaw in docker</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2026-02-09 20:28:44" itemprop="dateCreated datePublished" datetime="2026-02-09T20:28:44+08:00">2026-02-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/tools/" itemprop="url" rel="index"><span itemprop="name">tools</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h2><ul>
<li><strong>Bypass internet restrictions</strong></li>
<li>Docker Desktop (or Docker Engine) + Docker Compose v2</li>
<li>Enough disk for images + logs</li>
</ul>
<h2 id="Get-code-from-github"><a href="#Get-code-from-github" class="headerlink" title="Get code from github"></a>Get code from github</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/openclaw/openclaw.git</span><br></pre></td></tr></table></figure>

<h2 id="Containerized-Gateway"><a href="#Containerized-Gateway" class="headerlink" title="Containerized Gateway"></a>Containerized Gateway</h2><p>From repo root:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./docker-setup.sh</span><br></pre></td></tr></table></figure>
<p>This script: </p>
<ul>
<li>builds the gateway image</li>
<li>runs the onboarding wizard</li>
<li>prints optional provider setup hints</li>
<li>starts the gateway via Docker Compose</li>
<li>generates a gateway token and writes it to .env</li>
</ul>
<h2 id="Control-UI-token"><a href="#Control-UI-token" class="headerlink" title="Control UI token"></a>Control UI token</h2><p>If you see “unauthorized” or “disconnected (1008): pairing required”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;gateway&quot;: &#123;</span><br><span class="line">    &quot;controlUi&quot;: &#123; &quot;dangerouslyDisableDeviceAuth&quot;: true &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>By default, OpenClaw requires every connecting device to be “paired” (approved by an administrator). Since the Control UI is running in an “insecure” context<br>(HTTP inside Docker), it cannot generate a persistent device identity. Setting allowInsecureAuth: true tells the gateway to trust the Control UI if it provides<br>the correct token, skipping the pairing requirement.</p>
<h2 id="Install-feishu-plugin"><a href="#Install-feishu-plugin" class="headerlink" title="Install feishu plugin"></a>Install feishu plugin</h2><p>See URL below：<br><a target="_blank" rel="noopener" href="https://docs.openclaw.ai/channels/feishu">Feishu</a></p>
<h2 id="Install-skill"><a href="#Install-skill" class="headerlink" title="Install skill"></a>Install skill</h2><ol>
<li><p>goto the following site:<br><a target="_blank" rel="noopener" href="https://clawhub.ai/skills">https://clawhub.ai/skills</a></p>
</li>
<li><p>look for the skill you need. e.g. sonoscli</p>
</li>
<li><p>Execute</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx clawhub@latest install sonoscli</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Everything-is-ok"><a href="#Everything-is-ok" class="headerlink" title="Everything is ok"></a>Everything is ok</h2><p> <img src="/images/openclaw/feishu.png" alt="FEISHU"></p>
<h2 id="Some-problems："><a href="#Some-problems：" class="headerlink" title="Some problems："></a>Some problems：</h2><ol>
<li>“ plugin feishu: duplicate plugin id detected; later plugin may be overridden” <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node@45122743ed12:/app$ find / -name &quot;openclaw.plugin.json&quot; 2&gt;/dev/null | grep feishu   </span><br><span class="line">/home/node/.openclaw/extensions/feishu/openclaw.plugin.json  </span><br><span class="line">/app/extensions/feishu/openclaw.plugin.json</span><br></pre></td></tr></table></figure>
 You only need one feishu, delete the other one (I deleted the one under .openclaw, and deleting the one under app will cause the container to fail to start)</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jeffrey-fly-github-io.pages.dev/2026/02/01/database/CAP%E7%90%86%E8%AE%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jeffrey">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuantumRealm">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | QuantumRealm">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/02/01/database/CAP%E7%90%86%E8%AE%BA/" class="post-title-link" itemprop="url">CAP定理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2026-02-01 09:29:33" itemprop="dateCreated datePublished" datetime="2026-02-01T09:29:33+08:00">2026-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>CAP 定理指出，在分布式系统中，系统只能在以下三个属性中同时保证两个：</p>
<p><strong>一致性（Consistency，C）</strong>：所有节点看到相同的数据。对任一节点的写入操作，其后的所有读取都会返回更新后的值。</p>
<p><strong>可用性（Availability，A）</strong>：每个发给非故障节点的请求都会得到响应，但不保证响应包含最新数据。</p>
<p><strong>分区容错性（Partition Tolerance，P）</strong>：即使节点间发生网络分区或消息丢失，系统仍能继续运行。</p>
<p>在理想情况下（网络永不中断），可以同时拥有 C 和 A。但在实际环境中，网络延迟或中断不可避免，因此 P 通常被视为默认前提。真正的取舍在于 A 与 C：当网络分区发生时，是优先保证一致性，还是优先保证可用性？</p>
<p><img src="/images/cap/CAP.png" alt="CAP"></p>
<h2 id="一致性优先场景"><a href="#一致性优先场景" class="headerlink" title="一致性优先场景"></a>一致性优先场景</h2><ul>
<li><p>票务系统（如 12306）：若两个用户同时预订同一座位，系统必须确保只有一个用户成功，以避免重复分配。</p>
</li>
<li><p>账户余额：扣款成功后，用户在任何终端查询余额都应反映扣款后的最新结果</p>
</li>
</ul>
<h2 id="可用性优先场景"><a href="#可用性优先场景" class="headerlink" title="可用性优先场景"></a>可用性优先场景</h2><ul>
<li><p>社交媒体：用户更新个人信息后，短时间内其他用户可能仍看到旧信息，但系统不会返回错误。</p>
</li>
<li><p>OLAP 系统：处理海量报表数据时，由于同步延迟，系统可能无法实时反映最新写入，但仍能提供历史数据查询，保证系统可用性。</p>
</li>
</ul>
<h2 id="一致性的补充说明"><a href="#一致性的补充说明" class="headerlink" title="一致性的补充说明"></a>一致性的补充说明</h2><p>CAP 定理中所指的一致性通常是强一致性，即所有读取操作都反映最新写入。除此之外，还有其他一致性模型：</p>
<h3 id="强一致性（Strong-Consistency）"><a href="#强一致性（Strong-Consistency）" class="headerlink" title="强一致性（Strong Consistency）"></a>强一致性（Strong Consistency）</h3><p>所有读取均返回最新写入的数据，开销较大，但对银行账户等需要绝对准确性的系统至关重要。</p>
<h3 id="因果一致性（Causal-Consistency）"><a href="#因果一致性（Causal-Consistency）" class="headerlink" title="因果一致性（Causal Consistency）"></a>因果一致性（Causal Consistency）</h3><ul>
<li>保证具有因果关系的操作顺序一致，但允许无因果关系的操作顺序不同。</li>
<li>因果相关操作：如用户先发帖，再有回复，系统保证先看到发帖再看到回复。</li>
<li>并发无关操作：如不同用户同时点赞不同帖子，其顺序可以在各节点不同。</li>
</ul>
<p><strong>特殊实现</strong><br>读己所写（Read-Your-Own-Writes Consistency）：用户在同一会话中总能立即看到自己提交的更新。常用于社交媒体。</p>
<h3 id="最终一致性（Eventual-Consistency）："><a href="#最终一致性（Eventual-Consistency）：" class="headerlink" title="最终一致性（Eventual Consistency）："></a>最终一致性（Eventual Consistency）：</h3><p>系统在经过一段时间后最终达到一致状态，但短期内可能存在不一致数据。典型应用：ClickHouse、分布式缓存等。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jeffrey-fly-github-io.pages.dev/2026/01/20/database/Files-in-Clickhouse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jeffrey">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuantumRealm">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | QuantumRealm">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/20/database/Files-in-Clickhouse/" class="post-title-link" itemprop="url">Files_in_Clickhouse</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2026-01-20 10:57:54" itemprop="dateCreated datePublished" datetime="2026-01-20T10:57:54+08:00">2026-01-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="物理结构图"><a href="#物理结构图" class="headerlink" title="物理结构图"></a>物理结构图</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">primary.idx</span><br><span class="line"> ├─ entry 0  -&gt; granule 0</span><br><span class="line"> ├─ entry 1  -&gt; granule 1</span><br><span class="line"> └─ ...</span><br><span class="line"></span><br><span class="line">column.mrk4 (per column)</span><br><span class="line"> ├─ mark 0 -&gt; (compressed_offset, decompressed_offset) of granule 0</span><br><span class="line"> ├─ mark 1 -&gt; (compressed_offset, decompressed_offset) of granule 1</span><br><span class="line"> └─ ...</span><br><span class="line"></span><br><span class="line">data.bin</span><br><span class="line"> ├─ compressed block A</span><br><span class="line"> │    ├─ granule 0</span><br><span class="line"> │    └─ granule 1</span><br><span class="line"> ├─ compressed block B</span><br><span class="line"> │    └─ granule 2</span><br><span class="line"> └─ ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="primary-idx-primary-cidx（主键稀疏索引）"><a href="#primary-idx-primary-cidx（主键稀疏索引）" class="headerlink" title="primary.idx &#x2F; primary.cidx（主键稀疏索引）"></a>primary.idx &#x2F; primary.cidx（主键稀疏索引）</h3><p>主键索引文件，用于按 granule 粒度 进行范围裁剪（range pruning）。</p>
<p><strong>索引项（entry）生成规则</strong></p>
<ul>
<li><p>每当形成一个新的 granule，就会在 primary 索引中生成一个 entry</p>
</li>
<li><p>granule 的边界由以下两个条件之一触发（OR 关系）：</p>
<ul>
<li>行数达到 index_granularity（默认 8192 行）</li>
<li>ranule 内累计的 解压后数据大小 达到 index_granularity_bytes（通常约 10MB）</li>
</ul>
<p>  重要说明  </p>
<ul>
<li>granule 的行数是 上限约束，并非固定值</li>
<li>当 10MB 条件先触发时，一个 granule 的行数可能 明显小于 8192</li>
<li>primary 索引是 稀疏索引，只定位到 granule，而非单行</li>
</ul>
</li>
</ul>
<h3 id="column-mrk-column-mrk4（列级定位信息）"><a href="#column-mrk-column-mrk4（列级定位信息）" class="headerlink" title="column.mrk &#x2F; column.mrk4（列级定位信息）"></a>column.mrk &#x2F; column.mrk4（列级定位信息）</h3><p>对于 每一列，都有一个对应的 mark 文件，用于描述 每个 granule 在该列数据文件中的物理位置。</p>
<p><strong>mark 的数量关系</strong><br>每个 data part 中：primary.idx 中有多少个 entry，每个列的 .mrk &#x2F; .mrk4 文件中就有多少个 mark。二者在 granule 维度上 一一对应  </p>
<p>每个 mark 的内容<br>每个 mark 是一对偏移量：<br><strong>compressed_offset</strong> ：granule 所在压缩块在 .bin 文件中的起始字节偏移<br><strong>decompressed_offset</strong>：压缩块解压到内存后，该 granule 在解压后内存块中的起始字节偏移</p>
<p><strong>补充说明</strong><br>decompressed_offset 是 内存语义，不是磁盘语义。当一个压缩块只包含一个 granule 时，该值通常为 0；当一个压缩块包含多个 granule 时：第一个 granule 的 decompressed_offset &#x3D; 0；后续 granule 的 decompressed_offset 为其在解压后内存块中的字节偏移</p>
<h3 id="data-bin（列数据文件）"><a href="#data-bin（列数据文件）" class="headerlink" title="data.bin（列数据文件）"></a>data.bin（列数据文件）</h3><p><strong>物理结构</strong></p>
<p>data.bin 由多个 压缩块（compressed blocks） 顺序组成</p>
<p><strong>每个压缩块包含：</strong><br>1 个或多个完整 granule；任何一个 granule 都不会跨越压缩块边界</p>
<p><strong>关系约束</strong><br>一个 granule：必然完全位于某一个压缩块中；一个压缩块：可以包含多个 granule（取决于 granule 大小与压缩策略）</p>
<h3 id="其他文件"><a href="#其他文件" class="headerlink" title="其他文件"></a>其他文件</h3><ol>
<li><p>columns.txt：描述本 part 中：列名、列类型、列顺序</p>
</li>
<li><p>columns_substreams.txt：<br> 描述每个列的 子流（substream）布局。特别是：</p>
<ul>
<li>Nullable</li>
<li>Array</li>
<li>LowCardinality</li>
<li>Map</li>
</ul>
<p> 决定：一个逻辑列拆成几个 .bin &#x2F; .mrk</p>
</li>
<li><p>checksums.txt：记录本 part 中 每个文件的校验和与大小</p>
</li>
<li><p>count.txt：记录该 part 中的 行数，相当于 part 级的 “统计元数据”</p>
</li>
<li><p>serialization.json：描述 列的序列化 &#x2F; 反序列化方式</p>
</li>
<li><p>default_compression_codec.txt：记录该 part 使用的默认压缩算法（如 LZ4、ZSTD）</p>
</li>
<li><p>metadata_version.txt:表示该 part 的 metadata 版本</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jeffrey-fly-github-io.pages.dev/2026/01/16/database/BTree-vs-LSMTree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jeffrey">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuantumRealm">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | QuantumRealm">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/database/BTree-vs-LSMTree/" class="post-title-link" itemprop="url">B-Tree vs LSMTree</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2026-01-16 10:38:58" itemprop="dateCreated datePublished" datetime="2026-01-16T10:38:58+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>B-tree 和 LSM-tree 是数据密集型应用中用于组织和存储数据最广泛的两种数据结构。然而，两者各有优劣。本文旨在通过定量分析的方法对这两种数据结构进行对比。</p>
<h2 id="衡量指标"><a href="#衡量指标" class="headerlink" title="衡量指标"></a>衡量指标</h2><p>通常情况下，衡量数据结构性能有三个关键指标：写放大（Write Amplification）、读放大（Read Amplification）和空间放大（Space Amplification）。本节旨在对这些指标进行描述。</p>
<p>对于机械硬盘（HDD）而言，磁盘寻道成本极高，导致随机读写的性能远不如顺序读写。本文假设使用的是闪存存储（如 SSD），因此我们可以忽略磁盘寻道的成本。</p>
<h2 id="写放大（Write-Amplification）"><a href="#写放大（Write-Amplification）" class="headerlink" title="写放大（Write Amplification）"></a>写放大（Write Amplification）</h2><p>写放大（Write Amplification）是指写入存储设备的实际数据量与写入数据库的数据量之比。</p>
<p>例如，如果你向数据库写入了 10 MB 数据，但观察到磁盘实际产生了 30 MB 的写入量（或观测到磁盘写入带宽是数据库写入带宽的 3 倍），那么写放大就是 3</p>
<h2 id="读放大（Read-Amplification）"><a href="#读放大（Read-Amplification）" class="headerlink" title="读放大（Read Amplification）"></a>读放大（Read Amplification）</h2><p>读放大（Read Amplification）是指每次查询所需的磁盘读取次数。</p>
<p>例如，如果为了响应一个查询需要读取 5 个页面，那么读放大就是 5。</p>
<p>请注意，写放大与读放大的单位是不同的。写放大衡量的是实际写入数据量与应用程序预期写入量之间的倍数关系；而读放大计算的是执行一次查询所需的磁盘读取次数。</p>
<p>读放大针对点查询（Point Query）和范围查询（Range Query）有不同的定义。对于范围查询，范围的长度（即需要获取的行数）是一个重要因素。</p>
<p>缓存是影响读放大的关键因素。例如，对于冷缓存（Cold-cache）情况下的 B 树，一次点查询需要 O(log_B N)次磁盘读取；而在热缓存（Warm-cache）情况下，B 树的内部节点已被缓存，因此每次查询最多只需要一次磁盘读取。</p>
<blockquote>
<p>N：数据库中 记录（keys &#x2F; tuples）的总数量<br>B：一个磁盘页（page &#x2F; block）能容纳的 key 数量</p>
</blockquote>
<h2 id="空间放大（Space-Amplification）"><a href="#空间放大（Space-Amplification）" class="headerlink" title="空间放大（Space Amplification）"></a>空间放大（Space Amplification）</h2><p>空间放大（Space Amplification）是指存储设备上占用的实际数据量与数据库中存储的逻辑数据量之比。</p>
<p>例如，如果您向数据库存入 10 MB 的数据，而该数据库在磁盘上占用了 100 MB，那么空间放大倍数就是 10。</p>
<p>通常来说，一种数据结构最多只能在读、写和空间放大这三个指标中优化其中的两个。这意味着一种数据结构很难在所有三个指标上都优于另一种。例如，B 树的读放大比 LSM 树小，而 LSM 树的写放大则比 B 树小</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>B 树是二叉搜索树（Binary Search Tree）的一种推广，其节点可以拥有两个以上的子节点。B 树中有两类节点：内部节点（Internal nodes）和叶子节点（Leaf nodes）。叶子节点包含实际的数据记录且没有子节点；而内部节点可以在预定义的范围内拥有不同数量的子节点。内部节点可以进行合并或分裂。图 1 展示了一个 B 树的示例。</p>
<blockquote>
<p>图 1。根节点位于树的顶部，在本例中恰好包含一个枢轴键（Pivot keys）（20），这表示键值为 k 且满足 k &lt;&#x3D; 20 的记录存储在第一个子节点中，而键值满足 k &gt; 20 的记录存储在第二个子节点中。第一个子节点包含两个枢轴键（11 和 15），这表示键值满足 k &lt;&#x3D; 11 的记录存储在第一个（孙子）节点中，满足 11 &lt; k &lt;&#x3D; 15 的记录存储在第二个节点中，而满足 k &gt; 15 的记录则存储在第三个节点中。最左侧的叶子节点包含三个数值（3、5 和 7）。</p>
</blockquote>
<p>“B 树”一词可以指代一种特定的设计，也可以指代一类通用的设计。从狭义上讲，B 树在其内部节点中存储键（Keys），但并不一定在叶子节点的记录中重复存储这些键。B+ 树（B+ tree）是 B 树最著名的变体之一。B+ 树的核心理念是：内部节点仅包含键，且在底部增加了一个包含实际数值的额外层级，该层级的叶子节点相互连接。</p>
<p>与其他搜索树一样，LSM 树（LSM-tree）也包含键值对（Key-value pairs）。它将数据维护在两个或多个独立的组件中（有时被称为 SSTables），每个组件都针对其对应的底层存储介质进行了优化。低层组件中的数据会以批处理的方式高效地与高层组件中的数据进行合并。图 2 展示了一个 LSM 树的示例。</p>
<blockquote>
<p>图 2。LSM 树包含 $k$ 个组件。数据首先进入 $C_0$ 层，随后被合并到 $C_1$ 层。最终，$C_1$ 层的数据会被合并到 $C_2$ 层，以此类推。</p>
</blockquote>
<p>LSM 树会定期执行合并（Compaction）操作，将多个 SSTable 合并为一个仅包含“活跃数据”（Live data）的新 SSTable。合并操作有助于 LSM 树回收空间并降低读放大。合并策略主要有两种：大小分级合并策略（STCS）和层级合并策略（LBCS）。STCS 的核心思想是：当 LSM 树积累了足够的短小 SSTable 时，将其合并为中等大小的 SSTable；当中等 SSTable 足够多时，再将其合并为大型 SSTable。而 LBCS 的核心思想是将数据组织进不同的层级（Level），每个层级包含一个有序序列（Sorted run）。一旦某一层积累了足够的数据，该层级的部分数据就会被合并到更高层级中。</p>
<p>本文讨论 B+ 树和基于层级的（Level-Based）LSM 树的写放大与读放大。</p>
<h3 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B+ Tree"></a>B+ Tree</h3><p>在 B+ 树中，键（Keys）的副本存储在内部节点中；键与记录（Records）存储在叶子节点中；此外，叶子节点可能还包含指向下一个叶子节点的指针，以提高顺序访问性能。</p>
<p>为了简化分析，假设树的块大小（Block size）为 $B$（以字节为单位），且键、指针和记录的大小都是固定的，因此每个内部节点包含 $O(B)$ 个子节点，每个叶子节点包含 $O(B)$ 条数据记录。（根节点是一个特例，在某些情况下可能几乎为空。）在上述所有假设下，B+ 树的深度为：$$O(\log_B \frac{N}{B})$$其中 $N$ 是数据库的总大小。</p>
<p><strong>写放大 (Write Amplification)</strong><br>在最坏情况的插入负载下，每次插入都需要重写包含该记录的整个叶子块，因此写放大为 $B$。</p>
<p><strong>读放大 (Read Amplification)</strong><br>每次查询的磁盘读取次数最多为 $O(\log_B \frac{N}{B})$，即树的深度</p>
<h3 id="Level-Based-LSM-tree"><a href="#Level-Based-LSM-tree" class="headerlink" title="Level-Based LSM-tree"></a>Level-Based LSM-tree</h3><p>在基于层级的（Level-based）LSM 树中，数据按层组织。每一层包含一个有序序列。数据始于第 0 层（Level 0），随后被合并到第 1 层的序列中。最终，第 1 层的数据会被合并到第 2 层，以此类推。每一层的大小都受到限制。增长因子（Growth factor） $k$ 定义为每一层数据容量的放大倍数：</p>
<p>$$\text{level}<em>i &#x3D; \text{level}</em>{i-1} \times k$$</p>
<p>我们可以对基于层级的 LSM 树进行如下分析：如果增长因子为 $k$，且最小的层级是一个大小为 $B$ 的单个文件，那么层级的数量为：</p>
<p>$$\Theta(\log_k N&#x2F;B)$$</p>
<p>其中 $N$ 是数据库的大小。为了简化分析，我们假设数据库规模稳定且随时间增长缓慢，因此数据库的总大小几乎等同于最后一层的大小。</p>
<p><strong>写放大 (Write Amplification)</strong><br>数据必须从每一层移出一次，但给定层级的数据会与来自前一层的数据不断重复合并。平均而言，每个数据项在首次写入某一层后，会被重新合并回同一层约 $k&#x2F;2$ 次。因此，总的写放大为：$$\Theta(k \times \log_k N&#x2F;B)$$</p>
<p><strong>读放大 (Read Amplification)</strong> 在冷缓存情况下执行短范围查询时，我们必须在每个层级上进行二分查找。  </p>
<p>对于最高层级 $\text{level}_i$，数据大小为 $O(N)$，因此执行 $O(\log N&#x2F;B)$ 次磁盘读取。</p>
<p>对于上一层级 $\text{level}_{i-1}$，数据大小为 $O(N&#x2F;k)$，执行 $O(\log (N&#x2F;kB))$ 次磁盘读取。</p>
<p>对于 $\text{level}_{i-2}$ 层，数据大小为 $O(N&#x2F;k^2)$，执行 $O(\log (N&#x2F;k^2B))$ 次磁盘读取。</p>
<p>……</p>
<p>以此类推。</p>
<p>因此，磁盘读取的总次数为：$$R &#x3D; O(\log N&#x2F;B) + O(\log (N&#x2F;kB)) + O(\log (N&#x2F;k^2B)) + \dots + 1 &#x3D; O(\frac{\log^2 N&#x2F;B}{\log k})$$</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>下表总结了各种放大指标：</p>
<table>
<thead>
<tr>
<th>数据结构</th>
<th>写放大 (Write Amplification)</th>
<th>读放大 (Read Amplification)</th>
</tr>
</thead>
<tbody><tr>
<td>B+ 树</td>
<td>Θ(B)</td>
<td>O(logB​N&#x2F;B)</td>
</tr>
<tr>
<td>层级 LSM 树</td>
<td>Θ(klogk​N&#x2F;B)</td>
<td>Θ(logklog2N&#x2F;B​)</td>
</tr>
</tbody></table>
<p>通过对比 B+ 树与基于层级的 LSM 树的各种放大指标，我们可以得出结论：基于层级的 LSM 树在写入性能上优于 B+ 树，但在读取性能上则逊于 B+ 树。TiKV 选用 LSM 树而非 B 树作为其底层存储引擎的主要原因在于：利用缓存技术来提升读取性能，要比提升写入性能容易得多。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jeffrey-fly-github-io.pages.dev/2026/01/12/postgresql/how-to-use-pg-stat-statements-extension/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jeffrey">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuantumRealm">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | QuantumRealm">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/12/postgresql/how-to-use-pg-stat-statements-extension/" class="post-title-link" itemprop="url">How to use pg_stat_statements extension</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2026-01-12 10:33:28" itemprop="dateCreated datePublished" datetime="2026-01-12T10:33:28+08:00">2026-01-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/postgresql/" itemprop="url" rel="index"><span itemprop="name">postgresql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>pg_stat_statements 不能像 pageinspect 那样只靠 CREATE EXTENSION 就用，原因在于它们在 PostgreSQL 内核中的“级别”完全不同。</p>
<p>pg_stat_statements 和 pageinspect 的定位完全不同：它是一个 全局统计模块<br>它需要：</p>
<ol>
<li>拦截每一条 SQL 的执行<ul>
<li>使用 executor hooks</li>
<li>在 query 开始 &#x2F; 结束时采样</li>
</ul>
</li>
<li>shared memory 中维护全局 hash 表<ul>
<li>跨 backend 共享</li>
<li>保存长期累计统计</li>
</ul>
</li>
<li>在 backend 启动阶段完成初始化<ul>
<li>分配 shared memory</li>
<li>注册 hooks</li>
</ul>
</li>
</ol>
<p>这些事情 只能在 postmaster 启动时完成。</p>
<h2 id="启动步骤"><a href="#启动步骤" class="headerlink" title="启动步骤"></a>启动步骤</h2><ol>
<li>修改 postgresql.conf<br> 确认conf位置 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gujinfei=# show config_file;</span><br><span class="line">            config_file</span><br><span class="line">---------------------------------------</span><br><span class="line">/home/gujinfei/pgdata/postgresql.conf</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shared_preload_libraries = &#x27;pg_stat_statements&#x27;</span><br></pre></td></tr></table></figure></li>
<li>reboot database <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_ctl restart</span><br></pre></td></tr></table></figure></li>
<li>进入sql <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> shared_preload_libraries;</span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION pg_stat_statements;</span><br></pre></td></tr></table></figure></li>
<li>Test <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> t;</span><br><span class="line"><span class="keyword">create table</span> t(a text, b text, c <span class="type">int</span>);</span><br><span class="line"><span class="keyword">SELECT</span> pg_stat_statements_reset() <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">AS</span> t;</span><br><span class="line">explain(costs off, verbose) <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> t <span class="keyword">group</span> <span class="keyword">by</span> a;</span><br><span class="line">explain(costs off, verbose) <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> t <span class="keyword">group</span> <span class="keyword">by</span> b;</span><br><span class="line">explain(costs off, verbose) <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> t <span class="keyword">group</span> <span class="keyword">by</span> c;</span><br><span class="line"><span class="keyword">SELECT</span> calls, <span class="keyword">rows</span>, query <span class="keyword">FROM</span> pg_stat_statements <span class="keyword">ORDER</span> <span class="keyword">BY</span> query <span class="keyword">COLLATE</span> &quot;C&quot;;</span><br></pre></td></tr></table></figure>
 result <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">gujinfei<span class="operator">=</span># <span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> t;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span></span><br><span class="line">gujinfei<span class="operator">=</span># <span class="keyword">create table</span> t(a text, b text, c <span class="type">int</span>);</span><br><span class="line"><span class="keyword">CREATE TABLE</span></span><br><span class="line">gujinfei<span class="operator">=</span># <span class="keyword">SELECT</span> pg_stat_statements_reset() <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">AS</span> t;</span><br><span class="line">t</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">t</span><br><span class="line">(<span class="number">1</span> <span class="type">row</span>)</span><br><span class="line"></span><br><span class="line">gujinfei<span class="operator">=</span># explain(costs off, verbose) <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> t <span class="keyword">group</span> <span class="keyword">by</span> a;</span><br><span class="line">            QUERY PLAN</span><br><span class="line"><span class="comment">---------------------------------------</span></span><br><span class="line">HashAggregate</span><br><span class="line">Output: <span class="built_in">count</span>(<span class="operator">*</span>), a</span><br><span class="line"><span class="keyword">Group</span> Key: t.a</span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> public.t</span><br><span class="line">        Output: a, b, c</span><br><span class="line">Query Identifier: <span class="number">8735661759096201363</span></span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">gujinfei<span class="operator">=</span># explain(costs off, verbose) <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> t <span class="keyword">group</span> <span class="keyword">by</span> b;</span><br><span class="line">            QUERY PLAN</span><br><span class="line"><span class="comment">---------------------------------------</span></span><br><span class="line">HashAggregate</span><br><span class="line">Output: <span class="built_in">count</span>(<span class="operator">*</span>), b</span><br><span class="line"><span class="keyword">Group</span> Key: t.b</span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> public.t</span><br><span class="line">        Output: a, b, c</span><br><span class="line">Query Identifier: <span class="number">8735661759096201363</span></span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">gujinfei<span class="operator">=</span># explain(costs off, verbose) <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> t <span class="keyword">group</span> <span class="keyword">by</span> c;</span><br><span class="line">            QUERY PLAN</span><br><span class="line"><span class="comment">---------------------------------------</span></span><br><span class="line">HashAggregate</span><br><span class="line">Output: <span class="built_in">count</span>(<span class="operator">*</span>), c</span><br><span class="line"><span class="keyword">Group</span> Key: t.c</span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> public.t</span><br><span class="line">        Output: a, b, c</span><br><span class="line">Query Identifier: <span class="number">9219356609107396553</span></span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">gujinfei<span class="operator">=</span># <span class="keyword">SELECT</span> calls, <span class="keyword">rows</span>, query <span class="keyword">FROM</span> pg_stat_statements <span class="keyword">ORDER</span> <span class="keyword">BY</span> query <span class="keyword">COLLATE</span> &quot;C&quot;;</span><br><span class="line">calls <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span>                             query</span><br><span class="line"><span class="comment">-------+------+---------------------------------------------------------------</span></span><br><span class="line">    <span class="number">1</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">SELECT</span> pg_stat_statements_reset() <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">AS</span> t</span><br><span class="line">    <span class="number">2</span> <span class="operator">|</span>    <span class="number">0</span> <span class="operator">|</span> explain(costs off, verbose) <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> t <span class="keyword">group</span> <span class="keyword">by</span> a</span><br><span class="line">    <span class="number">1</span> <span class="operator">|</span>    <span class="number">0</span> <span class="operator">|</span> explain(costs off, verbose) <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> t <span class="keyword">group</span> <span class="keyword">by</span> c</span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">gujinfei<span class="operator">=</span>#</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jeffrey-fly-github-io.pages.dev/2026/01/11/database/%E4%B8%80%E8%87%B4%E6%80%A7hash/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jeffrey">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuantumRealm">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | QuantumRealm">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/11/database/%E4%B8%80%E8%87%B4%E6%80%A7hash/" class="post-title-link" itemprop="url">一致性hash</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2026-01-11 19:46:58" itemprop="dateCreated datePublished" datetime="2026-01-11T19:46:58+08:00">2026-01-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在分布式数据库中，一行数据最终会被写入哪一台机器，取决于系统所采用的数据分布策略。在使用分布键（distribution key）的场景下，这一过程通常由哈希计算精确映射完成。</p>
<p>这个映射过程通常从一个 <strong>distribution key（分布键）</strong> 开始，经由哈希函数，最终落到某一个具体的数据节点上。</p>
<p>看似简单的映射关系，在系统扩容或缩容时，却会成为分布式系统设计中的一个核心难题。一致性 Hash，正是为了解决这个问题而出现的。</p>
<hr>
<h2 id="从一个分布式表说起"><a href="#从一个分布式表说起" class="headerlink" title="从一个分布式表说起"></a>从一个分布式表说起</h2><p>以一个分布式数据库中的表为例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">bigint</span>,</span><br><span class="line">    user_id <span class="type">bigint</span>,</span><br><span class="line">    payload jsonb</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> create_distributed_table(<span class="string">&#x27;orders&#x27;</span>, <span class="string">&#x27;user_id&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>在这个例子中：</p>
<ul>
<li><code>user_id</code> 被指定为 <strong>distribution key</strong></li>
<li>数据库会对 <code>user_id</code> 计算哈希值</li>
<li>哈希值先映射到某个 <strong>shard</strong></li>
<li>shard 再映射到具体的 <strong>database node</strong><br>（shard -&gt; databasenode, 在本文后续省略，直接表示为 数据节点id，即database n）</li>
</ul>
<p>从这一刻开始，<code>user_id</code> 就决定了这行数据在物理层面“住在哪里”。</p>
<hr>
<h2 id="最直观的方案：取模-Hash"><a href="#最直观的方案：取模-Hash" class="headerlink" title="最直观的方案：取模 Hash"></a>最直观的方案：取模 Hash</h2><p>在多数据节点之间，最容易想到的一种数据分布方式是<strong>取模 Hash</strong>。</p>
<p>其基本思路非常直接：</p>
<ol>
<li>对 <code>user_id</code> 计算哈希值</li>
<li>用哈希值对数据库节点数量取模</li>
<li>取模结果即为目标数据库节点</li>
</ol>
<p>示意图如下：</p>
<p><img src="/images/hash/hash1.png" alt="hash1"></p>
<p>对应的算法可以表示为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">database_id = <span class="built_in">hash</span>(user_id) % num_of_dbs</span><br></pre></td></tr></table></figure>

<p>比如，当数据库集群拥有3个数据节点：</p>
<p>假设：<br>hash(123) &#x3D; 7<br>hash(456) &#x3D; 12<br>hash(789) &#x3D; 5</p>
<p>则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user id：123 → 7 % 3  = 1 → Database 1</span><br><span class="line">user id：456 → 12 % 3 = 0 → Database 0</span><br><span class="line">user id：789 → 5 % 3  = 2 → Database 2</span><br></pre></td></tr></table></figure>

<p>在数据节点数量固定的前提下，这种方式能够较为均匀地分布数据，实现也非常简单。</p>
<p>但问题很快就会出现。</p>
<hr>
<h2 id="问题一：扩容几乎等于“重来一遍”"><a href="#问题一：扩容几乎等于“重来一遍”" class="headerlink" title="问题一：扩容几乎等于“重来一遍”"></a>问题一：扩容几乎等于“重来一遍”</h2><p>随着业务增长，3 台数据节点已经无法承载当前数据量，需要扩容到 4 台。</p>
<p>算法随之变为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">database_id = <span class="built_in">hash</span>(user_id) % <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>对于<strong>新写入的数据</strong>来说，这个变化影响不大。但对于<strong>已有数据</strong>而言，情况就完全不同了。</p>
<p>由于取模基数发生变化，几乎所有 <code>user_id</code> 的映射结果都会改变，意味着：</p>
<blockquote>
<p><strong>存量数据需要在节点之间进行大规模重分布。</strong></p>
</blockquote>
<p>示意如下：</p>
<p><img src="/images/hash/hash2.png" alt="hash2"></p>
<p>例如，用户 <code>123</code> 过去映射到 Database 1，但现在：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash(123) % 4 = 3 （即：7%4）</span><br></pre></td></tr></table></figure>

<p>这行数据必须从Database 1迁移到 Database 3。</p>
<p>这种迁移不是个别现象，而是系统性问题，代价极其高昂。</p>
<blockquote>
<p>对于取模 Hash，当节点从 n 变为 n+1 时，数据迁移率约为 n&#x2F;(n+1)。这意味着如果从 9 台扩容到 10 台，会有 90% 的数据需要搬家</p>
</blockquote>
<hr>
<h2 id="问题二：缩容同样不可接受"><a href="#问题二：缩容同样不可接受" class="headerlink" title="问题二：缩容同样不可接受"></a>问题二：缩容同样不可接受</h2><p>缩容的情况并不会更好。</p>
<p>当某个节点被下线时，取模 Hash 同样会导致大规模数据重新分布，带来：</p>
<ul>
<li>大量数据迁移</li>
<li>IO 抖动</li>
<li>服务不稳定</li>
</ul>
<p>问题的本质在于：</p>
<blockquote>
<p><strong>节点数量一旦发生变化，整个哈希空间的映射关系就被彻底打乱。</strong></p>
</blockquote>
<p>为了解决这一问题，我们需要一种在节点变化时“尽量少动数据”的方案。</p>
<hr>
<h2 id="一致性-Hash-的核心思想"><a href="#一致性-Hash-的核心思想" class="headerlink" title="一致性 Hash 的核心思想"></a>一致性 Hash 的核心思想</h2><p>一致性 Hash 的目标很明确：</p>
<blockquote>
<p>在添加或删除节点时，尽可能减少需要重新分布的数据量。</p>
</blockquote>
<p>其基本做法是：</p>
<ol>
<li>将整个哈希值空间组织成一个<strong>虚拟的环</strong></li>
<li>哈希空间通常是 <code>0 ～ 2³²−1</code></li>
<li>数据节点和数据本身都映射到这个环上</li>
<li>数据沿顺时针方向，落到遇到的第一个节点上</li>
</ol>
<p>为便于说明，我们将哈希空间简化为 0～100，并假设通过哈希计算，4 个数据库节点在环上大致分布在如下位置：</p>
<p><img src="/images/hash/hash6.png" alt="hash6"></p>
<ul>
<li>DB1 → 0</li>
<li>DB2 → 25</li>
<li>DB3 → 50</li>
<li>DB4 → 75</li>
</ul>
<p>当我们对 <code>user_id</code> 计算哈希后：</p>
<ul>
<li>不再取模</li>
<li>而是在环上找到该哈希值</li>
<li>顺时针查找第一个数据库节点</li>
</ul>
<hr>
<h2 id="扩容时发生了什么？"><a href="#扩容时发生了什么？" class="headerlink" title="扩容时发生了什么？"></a>扩容时发生了什么？</h2><p>现在，我们在环上的位置 65 新增一个数据库节点 DB5。</p>
<p><img src="/images/hash/hash3.png" alt="hash3"></p>
<p>此时：</p>
<ul>
<li>只有哈希值位于 <code>(50, 65]</code> 区间的数据需要迁移</li>
<li>其他数据完全不受影响</li>
</ul>
<p>相比取模 Hash，数据迁移范围被大幅缩小。</p>
<hr>
<h2 id="缩容时的行为"><a href="#缩容时的行为" class="headerlink" title="缩容时的行为"></a>缩容时的行为</h2><p>缩容同样遵循相同的规则。</p>
<p>如果移除某个节点，其负责的哈希区间会顺延给下一个节点，而不会影响整个系统的映射关系。</p>
<p><img src="/images/hash/hash4.png" alt="hash4"></p>
<hr>
<h2 id="仍然存在的问题：负载不均"><a href="#仍然存在的问题：负载不均" class="headerlink" title="仍然存在的问题：负载不均"></a>仍然存在的问题：负载不均</h2><p>到这里，一致性 Hash 看起来已经非常理想了，但在工程实践中还会遇到一个问题：</p>
<blockquote>
<p><strong>节点之间的负载可能严重不均衡。</strong></p>
</blockquote>
<p>例如，在移除 DB3 的场景中：</p>
<p>原本属于 DB3 的全部数据会被顺延给同一个相邻节点</p>
<p>这可能导致某一台数据库瞬间成为性能瓶颈。</p>
<hr>
<h2 id="虚拟节点：工程上的关键改进"><a href="#虚拟节点：工程上的关键改进" class="headerlink" title="虚拟节点：工程上的关键改进"></a>虚拟节点：工程上的关键改进</h2><p>为了解决负载不均的问题，需要引入 <strong>虚拟节点（Virtual Nodes）</strong> 的概念。</p>
<p>核心思想是：</p>
<blockquote>
<p><strong>一个物理节点，在哈希环上不只占据一个位置。</strong></p>
</blockquote>
<p>具体做法是：</p>
<ul>
<li>对同一数据库节点构造多个不同的标识</li>
<li>分别计算哈希值</li>
<li>将这些位置都映射到同一台物理机器</li>
</ul>
<p>例如，对于节点 <code>database1</code>，可以构造：</p>
<ul>
<li><code>Hash(&quot;database1#1&quot;)</code> -&gt; pos(VDB1#1)</li>
<li><code>Hash(&quot;database1#2&quot;)</code> -&gt; pos(VDB1#2)</li>
<li><code>Hash(&quot;database1#3&quot;)</code> -&gt; pos(VDB1#3)</li>
<li><code>Hash(&quot;database1#4&quot;)</code> -&gt; pos(VDB1#4)</li>
</ul>
<p>它们在逻辑上是 4 个独立节点，但在物理上都指向同一台服务器。</p>
<p>示意如下：</p>
<p><img src="/images/hash/hash5.png" alt="hash5"></p>
<p>引入虚拟节点后：</p>
<ul>
<li>数据在环上的分布更加均匀</li>
<li>单个节点的负载波动被显著降低</li>
<li>扩容、缩容时的数据迁移成本进一步下降</li>
</ul>
<p>这是一致性 Hash 能够在工程实践中落地的关键一步。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一致性哈希的价值不在于分布是否更均匀，而在于节点变化时将重映射控制在最小范围</p>
<p>即：当系统发生变化时，如何控制变化的影响范围</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>普通取模哈希</th>
<th>一致性哈希</th>
</tr>
</thead>
<tbody><tr>
<td>节点变化影响</td>
<td>全局映射变化，大规模迁移</td>
<td>仅影响 hash 环上的局部区间</td>
</tr>
<tr>
<td>扩容&#x2F;缩容</td>
<td>不支持平滑扩容</td>
<td>支持在线、低迁移成本扩容</td>
</tr>
<tr>
<td>数据迁移比例</td>
<td>约为 1 − 1&#x2F;N</td>
<td>约为 1&#x2F;N</td>
</tr>
<tr>
<td>均衡性</td>
<td>天然均匀（前提：hash 好）</td>
<td>原生不均，通过虚拟节点改善</td>
</tr>
<tr>
<td>典型应用</td>
<td>本地分片、静态分区</td>
<td>分布式缓存、KV、分布式存储</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jeffrey-fly-github-io.pages.dev/2026/01/10/tools/Win11%E4%B8%8B%E4%BD%BF%E7%94%A8wsl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jeffrey">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuantumRealm">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | QuantumRealm">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/tools/Win11%E4%B8%8B%E4%BD%BF%E7%94%A8wsl/" class="post-title-link" itemprop="url">Win11下使用wsl</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2026-01-10 09:54:05" itemprop="dateCreated datePublished" datetime="2026-01-10T09:54:05+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/tools/" itemprop="url" rel="index"><span itemprop="name">tools</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="启动、停止"><a href="#启动、停止" class="headerlink" title="启动、停止"></a>启动、停止</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wsl #如果没有安装，会安装</span><br><span class="line">wsl --shutdown</span><br></pre></td></tr></table></figure>

<h2 id="查看已安装的版本"><a href="#查看已安装的版本" class="headerlink" title="查看已安装的版本"></a>查看已安装的版本</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\gujinfei&gt; wsl -l -v</span><br><span class="line">  NAME              STATE           VERSION</span><br><span class="line">* Ubuntu            Running         2</span><br><span class="line">  docker-desktop    Stopped         2</span><br><span class="line">PS C:\Users\gujinfei&gt;</span><br></pre></td></tr></table></figure>

<h2 id="启用主机代理，加速github访问"><a href="#启用主机代理，加速github访问" class="headerlink" title="启用主机代理，加速github访问"></a>启用主机代理，加速github访问</h2><p>进入： %UserProfile% 目录，编辑或者增加 .wslconfig 文件</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[wsl2]</span></span><br><span class="line"><span class="comment"># 开启镜像网络模式</span></span><br><span class="line"><span class="attr">networkingMode</span>=mirrored</span><br><span class="line"><span class="comment"># 自动代理转发</span></span><br><span class="line"><span class="attr">autoProxy</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="安装rust"><a href="#安装rust" class="headerlink" title="安装rust"></a>安装rust</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y build-essential curl pkg-config libssl-dev</span><br><span class="line">curl --proto &#x27;=https&#x27; --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br></pre></td></tr></table></figure>

<h2 id="一些配置"><a href="#一些配置" class="headerlink" title="一些配置"></a>一些配置</h2><ol>
<li>公私钥 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ed25519 -C &quot;jeffreyfly@icloud.com&quot;</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jeffrey-fly-github-io.pages.dev/2025/12/25/postgresql/dont-give-postgres-too-much-memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jeffrey">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuantumRealm">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | QuantumRealm">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/25/postgresql/dont-give-postgres-too-much-memory/" class="post-title-link" itemprop="url">【译】不要给 PostgreSQL 分配过多内存</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-25 00:00:00" itemprop="dateCreated datePublished" datetime="2025-12-25T00:00:00+08:00">2025-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/postgresql/" itemprop="url" rel="index"><span itemprop="name">postgresql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文为英文技术博客《Don’t give Postgres too much memory》的中文翻译。<br>原文作者：Tomas Vondra<br>原文链接：<a target="_blank" rel="noopener" href="https://vondra.me/posts/dont-give-postgres-too-much-memory/">https://vondra.me/posts/dont-give-postgres-too-much-memory/</a><br>本文接近原文直译，仅做结构整理与术语统一，所有观点归原作者所有。</p>
</blockquote>
<hr>
<h2 id="背景：一次“批处理”性能排查的经历"><a href="#背景：一次“批处理”性能排查的经历" class="headerlink" title="背景：一次“批处理”性能排查的经历"></a>背景：一次“批处理”性能排查的经历</h2><p>我时不时会被拉去排查一些与<strong>批处理（batch processing）</strong>相关的问题。<br>最近越来越常见的一种情况是：这些批处理进程会使用<strong>非常大的内存限制</strong>，尤其是：</p>
<ul>
<li><code>maintenance_work_mem</code></li>
<li><code>work_mem</code></li>
</ul>
<p>我猜不少 DBA 的思路是：</p>
<blockquote>
<p><strong>“内存越大越好。”</strong></p>
</blockquote>
<p>但他们往往没有意识到，这样做<strong>实际上可能会明显拖慢性能</strong>。</p>
<hr>
<h2 id="一个触发问题的实际案例"><a href="#一个触发问题的实际案例" class="headerlink" title="一个触发问题的实际案例"></a>一个触发问题的实际案例</h2><p>我用一个在测试 <strong>GIN 索引并行构建修复</strong> 时遇到的例子来说明这个问题。</p>
<p>这个 bug 本身并不复杂，也不算特别有意思，但它需要一个<strong>相当高的 <code>maintenance_work_mem</code></strong> 才能复现 —— 最初的报告里使用了 <strong>20GB</strong>。</p>
<p>为了验证修复是否有效，我在：</p>
<ul>
<li>不同的 <code>maintenance_work_mem</code> 设置</li>
<li>不同数量的并行 worker</li>
</ul>
<p>组合下，反复执行 <code>CREATE INDEX</code>。</p>
<p>本来的目标只是检查是否还会失败，但我同时也记录了执行时间，并将结果画成了一张图。</p>
<p><img src="/images/workmem/image.png" alt="mem"></p>
<hr>
<h2 id="测试环境说明"><a href="#测试环境说明" class="headerlink" title="测试环境说明"></a>测试环境说明</h2><p>测试运行在 Azure 上的一台 <strong>D96v4 实例</strong>：</p>
<ul>
<li><strong>CPU</strong>：Xeon Platinum 8573C  </li>
<li><strong>内存</strong>：384GB  </li>
<li><strong>存储</strong>：6 块 NVMe 组成 RAID0</li>
</ul>
<p>这意味着：</p>
<ul>
<li>数据基本全部命中缓存</li>
<li>瓶颈主要在 <strong>CPU，而不是磁盘 I&#x2F;O</strong></li>
</ul>
<hr>
<h2 id="并行化的效果（符合预期）"><a href="#并行化的效果（符合预期）" class="headerlink" title="并行化的效果（符合预期）"></a>并行化的效果（符合预期）</h2><p>并行化确实带来了明显收益：</p>
<ul>
<li><p>使用 <strong>2 个 worker（包括 leader）</strong><br>→ 性能提升约 <strong>1.8 倍</strong><br>→ 接近理想加速比（因为索引构建的最后阶段仍然是串行的）</p>
</li>
<li><p>随着 worker 数量继续增加：</p>
<ul>
<li>加速比逐渐下降  </li>
<li>例如 <strong>8 个 worker 只有约 4.5 倍</strong></li>
</ul>
</li>
</ul>
<p>这完全符合预期。</p>
<hr>
<h2 id="反直觉的现象：内存越大，反而越慢"><a href="#反直觉的现象：内存越大，反而越慢" class="headerlink" title="反直觉的现象：内存越大，反而越慢"></a>反直觉的现象：内存越大，反而越慢</h2><p>真正令人意外的是图中展示的另一个趋势：</p>
<blockquote>
<p><strong><code>maintenance_work_mem</code> 越大，索引构建反而越慢。</strong></p>
</blockquote>
<p>具体表现为：</p>
<ul>
<li>从 <strong>64MB</strong> 增加到 <strong>16GB</strong></li>
<li>索引构建时间增加了 <strong>约 30%</strong></li>
<li>并且 <strong>无论使用多少并行 worker，这一趋势都一致</strong></li>
</ul>
<p>为什么会这样？</p>
<hr>
<h2 id="原因概览"><a href="#原因概览" class="headerlink" title="原因概览"></a>原因概览</h2><p>这很可能是多种因素共同作用的结果。<br>下面我解释两个我认为<strong>最重要的原因</strong>：</p>
<ol>
<li><strong>L3 Cache 的大小限制</strong></li>
<li><strong>Linux 脏页（dirty page）回写机制</strong></li>
</ol>
<hr>
<h2 id="原因一：L3-Cache-的大小限制"><a href="#原因一：L3-Cache-的大小限制" class="headerlink" title="原因一：L3 Cache 的大小限制"></a>原因一：L3 Cache 的大小限制</h2><p>系统中的内存并不是“同一种速度”。</p>
<p>在 CPU 内部，存在一小块<strong>极快的缓存（L3 Cache）</strong>，访问延迟非常低。<br>但这部分内存通常只有 <strong>32MB～128MB</strong>。</p>
<p>相比之下：</p>
<ul>
<li>主内存（RAM）容量巨大</li>
<li>但访问延迟要高一个数量级</li>
</ul>
<hr>
<h3 id="索引构建中的内存访问模式"><a href="#索引构建中的内存访问模式" class="headerlink" title="索引构建中的内存访问模式"></a>索引构建中的内存访问模式</h3><p>在索引构建过程中，通常会经历以下流程：</p>
<ol>
<li>将数据累积到一个内存缓冲区</li>
<li>缓冲区“满了”之后进行处理</li>
<li>再合并到最终的索引结构中</li>
</ol>
<p>对于 <strong>GIN 索引</strong> 来说，这一步会把条目插入到一个<strong>哈希表</strong>中，这意味着：</p>
<blockquote>
<p><strong>大量随机内存访问</strong></p>
</blockquote>
<hr>
<h3 id="Cache-Miss-的代价"><a href="#Cache-Miss-的代价" class="headerlink" title="Cache Miss 的代价"></a>Cache Miss 的代价</h3><p>一旦这个哈希表的大小超过 <strong>L3 Cache</strong>，CPU 就不得不频繁访问主内存。</p>
<p>大致的访问代价是：</p>
<ul>
<li><strong>L3 Cache</strong>：约 <strong>20 个 CPU cycle</strong></li>
<li><strong>主内存</strong>：约 <strong>200 个 CPU cycle</strong></li>
</ul>
<p>也就是说，<strong>慢了一个数量级</strong>。</p>
<hr>
<h3 id="更优的策略"><a href="#更优的策略" class="headerlink" title="更优的策略"></a>更优的策略</h3><p>因此：</p>
<ul>
<li>将数据拆分成更小的批次处理</li>
<li>让工作集尽量能够放进 L3 Cache</li>
</ul>
<p>往往是更优的策略。</p>
<p>即使需要处理更多批次，<strong>总体上仍然可能更快</strong>。</p>
<p><strong>推荐阅读</strong>：<br>Ulrich Drepper，《<em>What Every Programmer Should Know About Memory</em>》（2007）<br>虽然年代久远，但内存层级的基本原理至今没有变化。</p>
<hr>
<h2 id="原因二：Linux-脏页（dirty-page）回写机制"><a href="#原因二：Linux-脏页（dirty-page）回写机制" class="headerlink" title="原因二：Linux 脏页（dirty page）回写机制"></a>原因二：Linux 脏页（dirty page）回写机制</h2><p>除了 CPU Cache，还有操作系统层面的因素。</p>
<p>当 GIN 的哈希表超过 <code>maintenance_work_mem</code> 限制时，数据会被写入<strong>临时文件</strong>。<br>这些文件不需要持久化保证，因此写入时只进入 <strong>page cache</strong>。</p>
<hr>
<h3 id="Linux-的脏页控制机制"><a href="#Linux-的脏页控制机制" class="headerlink" title="Linux 的脏页控制机制"></a>Linux 的脏页控制机制</h3><p>Linux 内核通过两个阈值控制脏页数量：</p>
<ul>
<li><code>vm.dirty_background_ratio</code>  <ul>
<li>达到后，后台开始异步回写</li>
</ul>
</li>
<li><code>vm.dirty_ratio</code>  <ul>
<li>达到后，<strong>所有写入变成同步写</strong>（非常致命）</li>
</ul>
</li>
</ul>
<p>理想状态下：</p>
<blockquote>
<p>后台回写足够快，永远不会触及 <code>vm.dirty_ratio</code></p>
</blockquote>
<hr>
<h3 id="大批量写入的问题"><a href="#大批量写入的问题" class="headerlink" title="大批量写入的问题"></a>大批量写入的问题</h3><p>问题在于：<br><strong>内核是否有“时间”去完成这些回写。</strong></p>
<p>假设构建哈希表需要累积 <strong>8GB 数据，用时 1 分钟</strong>：</p>
<h4 id="情况-A：一次性写出"><a href="#情况-A：一次性写出" class="headerlink" title="情况 A：一次性写出"></a>情况 A：一次性写出</h4><ul>
<li>1 分钟内几乎不写</li>
<li>最后一次性写出 8GB</li>
<li>短时间内产生大量脏页</li>
<li>极易触发同步写</li>
</ul>
<h4 id="情况-B：分批写出"><a href="#情况-B：分批写出" class="headerlink" title="情况 B：分批写出"></a>情况 B：分批写出</h4><ul>
<li>每 <strong>64MB</strong> 写一次</li>
<li>写操作均匀分布</li>
<li>内核有足够时间后台回写</li>
</ul>
<p>显然后者对系统更加友好。</p>
<hr>
<h2 id="总结（原文结论）"><a href="#总结（原文结论）" class="headerlink" title="总结（原文结论）"></a>总结（原文结论）</h2><p>以上所有分析，**同样适用于 <code>work_mem</code>**。</p>
<p>唯一的区别在于：</p>
<ul>
<li><code>maintenance_work_mem</code>  <ul>
<li>用于维护操作（<code>CREATE INDEX</code>、<code>VACUUM</code> 等）</li>
</ul>
</li>
<li><code>work_mem</code>  <ul>
<li>用于普通查询（<code>hash join</code>、<code>hash aggregate</code>、<code>sort</code> 等）</li>
</ul>
</li>
</ul>
<p>但底层原理完全一致：</p>
<ul>
<li>哈希表超过 L3 Cache → 性能下降</li>
<li>大块内存写入 → 脏页压力 → 可能触发同步写</li>
</ul>
<hr>
<h2 id="作者建议"><a href="#作者建议" class="headerlink" title="作者建议"></a>作者建议</h2><p>我并不知道 <code>maintenance_work_mem</code> 或 <code>work_mem</code> 的“最佳值”是多少，这也不是这篇文章的重点。</p>
<p>重点在于：</p>
<blockquote>
<p><strong>盲目把内存参数调得很大，可能会显著伤害性能。</strong></p>
</blockquote>
<p>我的建议是：</p>
<ul>
<li>从<strong>比较保守的值</strong>开始（例如 <strong>64MB</strong>）</li>
<li>只有在你能<strong>明确证明存在收益</strong>的情况下，才逐步调高</li>
</ul>
<hr>
<h2 id="原文信息"><a href="#原文信息" class="headerlink" title="原文信息"></a>原文信息</h2><ul>
<li>原文作者：Tomas Vondra  </li>
<li>原文地址：<a target="_blank" rel="noopener" href="https://vondra.me/posts/dont-give-postgres-too-much-memory/">https://vondra.me/posts/dont-give-postgres-too-much-memory/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jeffrey-fly-github-io.pages.dev/2025/12/22/postgresql/Distinct-Values/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jeffrey">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuantumRealm">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | QuantumRealm">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/22/postgresql/Distinct-Values/" class="post-title-link" itemprop="url">Distinct_Values</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-22 10:52:49" itemprop="dateCreated datePublished" datetime="2025-12-22T10:52:49+08:00">2025-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/postgresql/" itemprop="url" rel="index"><span itemprop="name">postgresql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>pg_stats 视图中的 n_distinct 字段表示某一列中不同取值（distinct values）的数量。</p>
<p>如果 n_distinct 为负数，其绝对值表示该列中不同取值所占的比例，而不是实际的不同值个数。例如，−1 表示该列中所有值都是唯一的；−3 表示平均而言，每个不同的值大约出现在 3 行中。当估计的不同值数量超过表中总行数的 10% 时，分析器（analyzer）会使用这种“比例”的表示方式。</p>
<p>如果预期数据是均匀分布的，则会直接使用不同值的数量。例如，在估算 column &#x3D; expression 这种条件的基数（cardinality）时，如果在规划阶段无法确定表达式的具体取值，查询规划器会假设该表达式可以以相同的概率取列中的任意一个值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">=</span><span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> flights</span><br><span class="line"><span class="keyword">WHERE</span> departure_airport <span class="operator">=</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> airport_code</span><br><span class="line">	<span class="keyword">FROM</span> airports</span><br><span class="line">	<span class="keyword">WHERE</span> city <span class="operator">=</span> <span class="string">&#x27;Saint Petersburg&#x27;</span></span><br><span class="line">);</span><br><span class="line">                          QUERY PLAN </span><br><span class="line">−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−</span><br><span class="line">Seq Scan <span class="keyword">on</span> flights (cost<span class="operator">=</span><span class="number">30.56</span>.<span class="number">.5340</span><span class="number">.40</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">2066</span> width<span class="operator">=</span><span class="number">63</span>) </span><br><span class="line">	<span class="keyword">Filter</span>: (departure_airport <span class="operator">=</span> $<span class="number">0</span>)</span><br><span class="line">	InitPlan <span class="number">1</span> (<span class="keyword">returns</span> $<span class="number">0</span>)</span><br><span class="line">		−<span class="operator">&gt;</span> Seq Scan <span class="keyword">on</span> airports_data ml (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.30</span><span class="number">.56</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> wi... </span><br><span class="line">			<span class="keyword">Filter</span>: ((city −<span class="operator">&gt;&gt;</span> lang()) <span class="operator">=</span> <span class="string">&#x27;Saint Petersburg&#x27;</span>::text)</span><br><span class="line">(<span class="number">5</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://jeffrey-fly-github-io.pages.dev/2025/12/19/postgresql/NULL-VALUES/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jeffrey">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QuantumRealm">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | QuantumRealm">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/19/postgresql/NULL-VALUES/" class="post-title-link" itemprop="url">NULL VALUES</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-19 10:52:49" itemprop="dateCreated datePublished" datetime="2025-12-19T10:52:49+08:00">2025-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/postgresql/" itemprop="url" rel="index"><span itemprop="name">postgresql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>虽然理论学家对此不以为然，但 NULL 值在关系型数据库中仍然扮演着重要角色：它提供了一种方便的方式来表示某个值要么未知，要么不存在。</p>
<p>然而，特殊的值需要特殊处理。除了理论上的不一致性之外，还有许多实际问题需要考虑。常规的布尔逻辑被三值逻辑取代，因此 NOT IN 的行为可能出乎意料。对于 NULL 值应该被视为大于还是小于普通值也不明确（因此存在用于排序的 NULLS FIRST 和 NULLS LAST 子句）。是否需要在聚合函数中考虑 NULL 值也并不十分明显。严格来说，NULL 根本不是一个值，因此优化器在处理它们时需要额外的信息。</p>
<p>除了在表级收集的最基本的统计信息之外，分析器还会为表的每一列收集统计信息。这些数据存储在系统目录的 <em>pg_statistic</em> 表中，但你也可以通过 pg_stats 视图访问，这个视图以更方便的格式提供这些信息。<br>列级统计信息中包括 NULL 值的比例；在分析过程中计算，并以 null_frac 属性表示。<br>例如，当我们查询尚未起飞的航班时，可以依赖它们的起飞时间未定义（NULL）这一事实：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">=</span><span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> flights <span class="keyword">WHERE</span> actual_departure <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line">							QUERY PLAN </span><br><span class="line">−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−</span><br><span class="line">Seq Scan <span class="keyword">on</span> flights (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.4772</span><span class="number">.67</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">16702</span> width<span class="operator">=</span><span class="number">63</span>) <span class="keyword">Filter</span>: (actual_departure <span class="keyword">IS</span> <span class="keyword">NULL</span>)</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>
<p>为了估算结果，优化器将表的总行数乘以 NULL 值的比例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">=</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> round(reltuples <span class="operator">*</span> s.null_frac) <span class="keyword">AS</span> <span class="keyword">rows</span> <span class="keyword">FROM</span> pg_class</span><br><span class="line"><span class="keyword">JOIN</span> pg_stats s <span class="keyword">ON</span> s.tablename <span class="operator">=</span> relname <span class="keyword">WHERE</span> s.tablename <span class="operator">=</span> <span class="string">&#x27;flights&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> s.attname <span class="operator">=</span> <span class="string">&#x27;actual_departure&#x27;</span>;</span><br><span class="line"> <span class="keyword">rows</span> </span><br><span class="line">−−−−−−−</span><br><span class="line"><span class="number">16702</span> </span><br><span class="line">(<span class="number">1</span> <span class="type">row</span>)</span><br></pre></td></tr></table></figure>

<p>以下是实际的行数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> flights <span class="keyword">WHERE</span> actual_departure <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"> count </span><br><span class="line">−−−−−−− </span><br><span class="line"> <span class="number">16348</span> </span><br><span class="line">(<span class="number">1</span> <span class="type">row</span>)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Jeffrey</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
